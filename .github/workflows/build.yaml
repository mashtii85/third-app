name: Build

on: [push]
  # push:
    # tags:
    #   - v*
jobs:
  build:
    name: hi
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      # - name: Get the two latest versions
      #   run: |
          # CURRENT_VERSION=$(git tag -l "v*" --sort=-version:refname | head -n 1)
          # LAST_VERSION=$(git tag -l "v*" --sort=-version:refname | head -n 2 | awk 'NR == 2 { print $1 }')
          # echo "current_version=$(echo $CURRENT_VERSION)" >> $GITHUB_ENV
          # echo "last_version=$(echo $LAST_VERSION)" >> $GITHUB_ENV
      - name: Setup NodeJS 14
        uses: actions/setup-node@v1
        with:
          node-version: 14

      - name: Install yarn
        run: npm install -g yarn

      - name: Get yarn cache directory path
        id: yarn-cache-dir-path
        run: echo "::set-output name=dir::$(yarn config get cacheFolder)"

      - name: Cache yarn dependencies
        uses: actions/cache@v2
        id: yarn-cache
        with:
          path: |
            ${{ steps.yarn-cache-dir-path.outputs.dir }}
            **\node_modules
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-
      - name: Install dependencies
        if: steps.yarn-cache.outputs.cache-hit != 'true'
        run: yarn install

      # - name: Build libraries
      #   run: |
      #     # yarn nx affected:libs --target=build --prod --skip-nx-cache #--base=origin/develop --head=HEAD
      #     yarn nx affected:build --prod --base=origin/develop~1 --head=origin/develop

      # - name: Build
      #   run: |
      #       yarn nx build nest-utils
    #  - name: Build Artifacts
    #    run: |
    #       cd ./dist/libs/nest-utils
    #       npm pack
    #       echo github.repository_owner
      - name: Build Library
        run: |
          yarn nx affected:libs  --target=build-lib --base=develop --head=HEAD --base=origin/develop~1

      - name: Affected Builds
        env:
          command: yarn nx affected:libs --target=build --base=origin/develop~1 --head=HEAD --plain

        run: |

          echo '::set-output name=AFFECTED_LIBS::${{ env.command }}'

        id: affected-builds
      - name: Build components (Github packages)

        run: |
          echo 'libs=> ${{ steps.affected-builds.outputs.AFFECTED_LIBS }}'
          for LIBRARY in $(${{ steps.affected-builds.outputs.AFFECTED_LIBS }} | awk 'NR > 2 && $1 != "Done" { print $1 }')
          do
            cd ./dist/libs/$LIBRARY
            # npm publish --registry https://npm.pkg.github.com --no-git-tag-version --no-push --yes
            echo "lib name:$LIBRARY"
            echo pwd
            cd ..
            cd ..
          done

      - name: Upload
        uses: actions/upload-artifact@v2
        with:
            name: package
            path: "./dist/libs/nest-utils/*.tgz"
          # npm publish --registry https://npm.pkg.github.com --no-git-tag-version --no-push --yes

        # env:
        #   GITHUB_TOKEN: ${{ secrets.CI_REPOSITORY_ACCESS_TOKEN }}
  # publish:
  #   needs: [build]
  #   runs-on: ubuntu-18.04
  #   if: github.repository_owner == 'DryKISS'
  #   steps:
  #     - name: Upload
  #       uses: actions/download-artifact@v2
  #       with:
  #         name: package
  #     - uses: actions/setup-node@v1
  #       with:
  #         node-version: 14.x
  #         registry-url: https://npm.pkg.github.com/
  #         scope: '@DryKISS'
  #     - run: echo "registry=https://npm.pkg.github.com/@DryKISS" >> .npmrc
  #     - run: npm publish $(ls *.tgz)
  #       env:
  #         NODE_AUTH_TOKEN: ${{secrets.CI_REPOSITORY_ACCESS_TOKEN}}

